===============================================================================
plugin-architecture
===============================================================================
Plugin architecture with core providing interfaces and plugins implementing them.

--- file: Cargo.toml ---
[workspace]
members = ["core", "plugin-a", "plugin-b", "runtime"]

--- file: core/Cargo.toml ---
[package]
name = "core"
version = "0.1.0"

--- file: core/src/lib.rs ---
pub mod plugin;

--- file: core/src/plugin.rs ---
pub struct Context {
    pub name: String,
}

pub struct Event {
    pub kind: String,
    pub data: String,
}

pub trait Plugin {
    fn name(&self) -> String;
    fn init(&mut self, ctx: Context);
    fn handle(&self, event: Event) -> Event;
}

--- file: plugin-a/Cargo.toml ---
[package]
name = "plugin-a"
version = "0.1.0"

[dependencies]
core = { path = "../core" }

--- file: plugin-a/src/lib.rs ---
use core::plugin::{Plugin, Context, Event};

pub struct PluginA {
    name: String,
}

impl PluginA {
    pub fn new() -> Self {
        Self { name: String::new() }
    }
}

impl Plugin for PluginA {
    fn name(&self) -> String {
        self.name.clone()
    }
    fn init(&mut self, ctx: Context) {
        self.name = ctx.name;
    }
    fn handle(&self, event: Event) -> Event {
        event
    }
}

--- file: plugin-b/Cargo.toml ---
[package]
name = "plugin-b"
version = "0.1.0"

[dependencies]
core = { path = "../core" }

--- file: plugin-b/src/lib.rs ---
use core::plugin::{Plugin, Context, Event};

pub struct PluginB {
    initialized: bool,
}

impl PluginB {
    pub fn new() -> Self {
        Self { initialized: false }
    }
}

impl Plugin for PluginB {
    fn name(&self) -> String {
        String::from("plugin-b")
    }
    fn init(&mut self, _ctx: Context) {
        self.initialized = true;
    }
    fn handle(&self, event: Event) -> Event {
        Event { kind: event.kind, data: String::from("processed") }
    }
}

--- file: runtime/Cargo.toml ---
[package]
name = "runtime"
version = "0.1.0"

[dependencies]
core = { path = "../core" }
plugin-a = { path = "../plugin-a" }
plugin-b = { path = "../plugin-b" }

--- file: runtime/src/lib.rs ---
use core::plugin::{Context, Event};
use plugin_a::PluginA;
use plugin_b::PluginB;

pub struct Runtime {
    pub plugin_a: PluginA,
    pub plugin_b: PluginB,
}

impl Runtime {
    pub fn new() -> Self {
        Self {
            plugin_a: PluginA::new(),
            plugin_b: PluginB::new(),
        }
    }

    pub fn dispatch(&self, event: Event) -> Event {
        event
    }
}

pub fn create_context(name: String) -> Context {
    Context { name }
}

--- expect:block-graph ---
(root:1 lib ($TMP/core/src/lib.rs)
  (module:2 plugin)
)

(root:3 plugin ($TMP/core/src/plugin.rs)
  (class:4 Context
    (field:5 name @type String)
  )
  (class:6 Event
    (field:7 kind @type String)
    (field:8 data @type String)
  )
  (trait:9 Plugin
    (method:10 name
      (parameter:11 self @type:9 Plugin)
      (return:12 @type String)
    )
    (method:13 init
      (parameter:14 self @type:9 Plugin)
      (parameter:15 ctx @type:4 Context)
    )
    (method:16 handle
      (parameter:17 self @type:9 Plugin)
      (parameter:18 event @type:6 Event)
      (return:19 @type:6 Event)
      (@tdep:6 Event)
    )
  )
)

(root:20 lib ($TMP/plugin-a/src/lib.rs)
  (class:21 PluginA
    (field:22 name @type String)
  )
  (impl:23 PluginA @type:21
    (method:24 new
      (return:25 @type:21 PluginA)
    )
  )
  (impl:27 PluginA @type:21 @trait:9
    (method:28 name
      (parameter:29 self @type:21 PluginA)
      (return:30 @type String)
    )
    (method:32 init
      (parameter:33 self @type:21 PluginA)
      (parameter:34 ctx @type:4 Context)
    )
    (method:35 handle
      (parameter:36 self @type:21 PluginA)
      (parameter:37 event @type:6 Event)
      (return:38 @type:6 Event)
      (@tdep:6 Event)
    )
  )
)

(root:39 lib ($TMP/plugin-b/src/lib.rs)
  (class:40 PluginB
    (field:41 initialized @type bool)
  )
  (impl:42 PluginB @type:40
    (method:43 new
      (return:44 @type:40 PluginB)
    )
  )
  (impl:45 PluginB @type:40 @trait:9
    (method:46 name
      (parameter:47 self @type:40 PluginB)
      (return:48 @type String)
    )
    (method:50 init
      (parameter:51 self @type:40 PluginB)
      (parameter:52 _ctx @type:4 Context)
    )
    (method:53 handle
      (parameter:54 self @type:40 PluginB)
      (parameter:55 event @type:6 Event)
      (return:56 @type:6 Event)
      (@tdep:6 Event)
    )
  )
)

(root:58 lib ($TMP/runtime/src/lib.rs)
  (class:59 Runtime
    (field:60 plugin_a @type:21 PluginA)
    (field:61 plugin_b @type:40 PluginB)
    (@tdep:21 PluginA)
    (@tdep:40 PluginB)
  )
  (impl:62 Runtime @type:59
    (method:63 new
      (return:64 @type:59 Runtime)
      (@tdep:21 PluginA)
      (@tdep:40 PluginB)
    )
    (method:67 dispatch
      (parameter:68 self @type:59 Runtime)
      (parameter:69 event @type:6 Event)
      (return:70 @type:6 Event)
      (@tdep:6 Event)
    )
  )
  (func:71 create_context
    (parameter:72 name @type String)
    (return:73 @type:4 Context)
    (@tdep:4 Context)
  )
)

--- expect:arch-graph ---
digraph architecture {
  // Layout settings
  rankdir=TB;
  ranksep=0.6;
  nodesep=0.3;
  splines=ortho;
  compound=true;

  node [shape=box, style=rounded];
  edge [arrowsize=0.7];

  subgraph cluster_core {
    label="core";
    style=rounded;
    color="#888888";
    bgcolor="#f0f0f0";

    subgraph cluster_plugin_rs {
      label="plugin.rs";
      style=rounded;
      color="#aaaaaa";
      bgcolor="#fafafa";

      n4[label="Context", full_path="$TMP/core/src/plugin.rs:1", sym_ty="Struct", shape=box];
      n9[label="Plugin", full_path="$TMP/core/src/plugin.rs:10", sym_ty="Trait", shape=box];
    }

  }

  subgraph cluster_plugin_a {
    label="plugin-a";
    style=rounded;
    color="#888888";
    bgcolor="#f0f0f0";

    subgraph cluster_lib_rs {
      label="lib.rs";
      style=rounded;
      color="#aaaaaa";
      bgcolor="#fafafa";

      n21[label="PluginA", full_path="$TMP/plugin-a/src/lib.rs:3", sym_ty="Struct", shape=box];
    }

  }

  subgraph cluster_plugin_b {
    label="plugin-b";
    style=rounded;
    color="#888888";
    bgcolor="#f0f0f0";

    subgraph cluster_lib_rs {
      label="lib.rs";
      style=rounded;
      color="#aaaaaa";
      bgcolor="#fafafa";

      n40[label="PluginB", full_path="$TMP/plugin-b/src/lib.rs:3", sym_ty="Struct", shape=box];
    }

  }

  subgraph cluster_runtime {
    label="runtime";
    style=rounded;
    color="#888888";
    bgcolor="#f0f0f0";

    subgraph cluster_lib_rs {
      label="lib.rs";
      style=rounded;
      color="#aaaaaa";
      bgcolor="#fafafa";

      n71[label="create_context", full_path="$TMP/runtime/src/lib.rs:23", sym_ty="Function", shape=ellipse];
      n59[label="Runtime", full_path="$TMP/runtime/src/lib.rs:5", sym_ty="Struct", shape=box];
    }

  }


  n9 -> n21 [from="trait", to="impl"];
  n9 -> n40 [from="trait", to="impl"];
  n21 -> n59 [from="field_type", to="struct"];
  n40 -> n59 [from="field_type", to="struct"];
  n71 -> n4 [from="func", to="output"];
}
