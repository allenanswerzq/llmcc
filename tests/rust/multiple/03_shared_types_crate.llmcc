===============================================================================
shared-types-crate
===============================================================================
Multiple crates sharing a common types crate.

--- file: Cargo.toml ---
[workspace]
members = ["types", "auth", "store"]

--- file: types/Cargo.toml ---
[package]
name = "types"
version = "0.1.0"

--- file: types/src/lib.rs ---
pub mod common;

--- file: types/src/common.rs ---
pub struct UserId(pub u64);

pub struct Email(pub String);

pub struct User {
    pub id: UserId,
    pub email: Email,
}

pub enum AuthError {
    InvalidCredentials,
    Expired,
    Forbidden,
}

pub enum StoreError {
    NotFound,
    Conflict,
    Internal,
}

--- file: auth/Cargo.toml ---
[package]
name = "auth"
version = "0.1.0"

[dependencies]
types = { path = "../types" }

--- file: auth/src/lib.rs ---
pub mod auth;

--- file: auth/src/auth.rs ---
use types::common::{User, UserId, AuthError};

pub struct Session {
    pub user: User,
    pub token: String,
}

pub fn authenticate(user_id: UserId, password: String) -> Result<Session, AuthError> {
    Err(AuthError::InvalidCredentials)
}

pub fn validate_session(session: Session) -> Result<User, AuthError> {
    Ok(session.user)
}

--- file: store/Cargo.toml ---
[package]
name = "store"
version = "0.1.0"

[dependencies]
types = { path = "../types" }

--- file: store/src/lib.rs ---
pub mod repository;

--- file: store/src/repository.rs ---
use types::common::{User, UserId, StoreError};

pub trait UserStore {
    fn get(&self, id: UserId) -> Result<User, StoreError>;
    fn save(&self, user: User) -> Result<User, StoreError>;
    fn delete(&self, id: UserId) -> Result<(), StoreError>;
}

pub fn find_user(id: UserId) -> Result<User, StoreError> {
    Err(StoreError::NotFound)
}

--- expect:block-graph ---
(root:1 lib ($TMP/types/src/lib.rs)
  (module:2 common)
)

(root:3 common ($TMP/types/src/common.rs)
  (class:4 UserId
    (field:5 0 @type u64)
  )
  (class:6 Email
    (field:7 0 @type String)
  )
  (class:8 User
    (field:9 id @type:4 UserId)
    (field:10 email @type:6 Email)
    (@tdep:4 UserId)
    (@tdep:6 Email)
  )
  (enum:11 AuthError
    (field:12 InvalidCredentials)
    (field:13 Expired)
    (field:14 Forbidden)
  )
  (enum:15 StoreError
    (field:16 NotFound)
    (field:17 Conflict)
    (field:18 Internal)
  )
)

(root:19 lib ($TMP/auth/src/lib.rs)
  (module:20 auth)
)

(root:21 auth ($TMP/auth/src/auth.rs)
  (class:22 Session
    (field:23 user @type:8 User)
    (field:24 token @type String)
    (@tdep:8 User)
  )
  (func:25 authenticate
    (parameter:26 user_id @type:4 UserId)
    (parameter:27 password @type String)
    (return:28)
    (@tdep:11 AuthError)
    (@tdep:22 Session)
  )
  (func:30 validate_session
    (parameter:31 session @type:22 Session)
    (return:32)
    (@tdep:8 User)
    (@tdep:11 AuthError)
  )
)

(root:34 lib ($TMP/store/src/lib.rs)
  (module:35 repository)
)

(root:36 repository ($TMP/store/src/repository.rs)
  (trait:37 UserStore
    (method:38 get
      (parameter:39 self @type:37 UserStore)
      (parameter:40 id @type:4 UserId)
      (return:41)
      (@tdep:8 User)
      (@tdep:15 StoreError)
    )
    (method:42 save
      (parameter:43 self @type:37 UserStore)
      (parameter:44 user @type:8 User)
      (return:45)
      (@tdep:8 User)
      (@tdep:15 StoreError)
    )
    (method:46 delete
      (parameter:47 self @type:37 UserStore)
      (parameter:48 id @type:4 UserId)
      (return:49)
      (@tdep:15 StoreError)
    )
  )
  (func:50 find_user
    (parameter:51 id @type:4 UserId)
    (return:52)
    (@tdep:8 User)
    (@tdep:15 StoreError)
  )
)

--- expect:arch-graph ---
digraph architecture {
  rankdir=TB;
  ranksep=0.6;
  nodesep=0.3;
  splines=ortho;
  compound=true;

  node [shape=box, style=rounded];
  edge [arrowsize=0.7];

  subgraph cluster_auth {
    label="auth";
    bgcolor="#f8f8f8";

    subgraph cluster_auth_rs {
      label="auth.rs";
      bgcolor="#fafafa";

      n30[label="validate_session", full_path="$TMP/auth/src/auth.rs:12", sym_ty="Function", shape=ellipse];
      n22[label="Session", full_path="$TMP/auth/src/auth.rs:3", sym_ty="Struct", shape=box];
      n25[label="authenticate", full_path="$TMP/auth/src/auth.rs:8", sym_ty="Function", shape=ellipse];
    }

  }

  subgraph cluster_store {
    label="store";
    bgcolor="#f8f8f8";

    subgraph cluster_repository_rs {
      label="repository.rs";
      bgcolor="#fafafa";

      n50[label="find_user", full_path="$TMP/store/src/repository.rs:9", sym_ty="Function", shape=ellipse];
    }

  }

  subgraph cluster_types {
    label="types";
    bgcolor="#f8f8f8";

    subgraph cluster_common_rs {
      label="common.rs";
      bgcolor="#fafafa";

      n4[label="UserId", full_path="$TMP/types/src/common.rs:1", sym_ty="Struct", shape=box];
      n11[label="AuthError", full_path="$TMP/types/src/common.rs:10", sym_ty="Enum", shape=box];
      n15[label="StoreError", full_path="$TMP/types/src/common.rs:16", sym_ty="Enum", shape=box];
      n6[label="Email", full_path="$TMP/types/src/common.rs:3", sym_ty="Struct", shape=box];
      n8[label="User", full_path="$TMP/types/src/common.rs:5", sym_ty="Struct", shape=box];
    }

  }


  n4 -> n8 [from="field_type", to="struct"];
  n4 -> n25 [from="input", to="func"];
  n4 -> n50 [from="input", to="func"];
  n6 -> n8 [from="field_type", to="struct"];
  n8 -> n22 [from="field_type", to="struct"];
  n22 -> n30 [from="input", to="func"];
  n25 -> n11 [from="func", to="type_dep"];
  n25 -> n22 [from="func", to="type_dep"];
  n30 -> n8 [from="func", to="type_dep"];
  n30 -> n11 [from="func", to="type_dep"];
  n50 -> n8 [from="func", to="type_dep"];
  n50 -> n15 [from="func", to="type_dep"];
}
