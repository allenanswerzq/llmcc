===============================================================================
three-crates-layered
===============================================================================
Three-layer architecture: domain -> service -> api.

--- file: Cargo.toml ---
[workspace]
members = ["domain", "service", "api"]

--- file: domain/Cargo.toml ---
[package]
name = "domain"
version = "0.1.0"

--- file: domain/src/lib.rs ---
pub mod models;

--- file: domain/src/models.rs ---
pub struct User {
    pub id: u64,
    pub email: String,
}

pub struct Order {
    pub id: u64,
    pub user_id: u64,
    pub amount: f64,
}

pub enum OrderStatus {
    Pending,
    Confirmed,
    Shipped,
    Delivered,
}

--- file: service/Cargo.toml ---
[package]
name = "service"
version = "0.1.0"

[dependencies]
domain = { path = "../domain" }

--- file: service/src/lib.rs ---
pub mod user_service;
pub mod order_service;

--- file: service/src/user_service.rs ---
use domain::models::User;

pub trait UserRepository {
    fn find_by_id(&self, id: u64) -> Option<User>;
    fn save(&self, user: User) -> User;
}

pub fn get_user(id: u64) -> Option<User> {
    None
}

--- file: service/src/order_service.rs ---
use domain::models::{Order, OrderStatus};

pub trait OrderRepository {
    fn find_by_id(&self, id: u64) -> Option<Order>;
    fn update_status(&self, id: u64, status: OrderStatus);
}

pub fn process_order(order: Order) -> OrderStatus {
    OrderStatus::Confirmed
}

--- file: api/Cargo.toml ---
[package]
name = "api"
version = "0.1.0"

[dependencies]
domain = { path = "../domain" }
service = { path = "../service" }

--- file: api/src/lib.rs ---
pub mod handlers;

--- file: api/src/handlers.rs ---
use domain::models::{User, Order};
use service::user_service::get_user;
use service::order_service::process_order;

pub struct ApiResponse {
    pub success: bool,
    pub data: Option<User>,
}

pub fn handle_get_user(id: u64) -> ApiResponse {
    let user = get_user(id);
    ApiResponse { success: user.is_some(), data: user }
}

pub fn handle_order(order: Order) -> bool {
    let _ = process_order(order);
    true
}

--- expect:block-graph ---
(root:1 lib ($TMP/domain/src/lib.rs)
  (module:2 models)
)

(root:3 models ($TMP/domain/src/models.rs)
  (class:4 User
    (field:5 id @type u64)
    (field:6 email @type String)
  )
  (class:7 Order
    (field:8 id @type u64)
    (field:9 user_id @type u64)
    (field:10 amount @type f64)
  )
  (enum:11 OrderStatus
    (field:12 Pending)
    (field:13 Confirmed)
    (field:14 Shipped)
    (field:15 Delivered)
  )
)

(root:16 lib ($TMP/service/src/lib.rs)
  (module:17 user_service)
  (module:18 order_service)
)

(root:19 user_service ($TMP/service/src/user_service.rs)
  (trait:20 UserRepository
    (method:21 find_by_id
      (parameter:22 self @type:20 UserRepository)
      (parameter:23 id @type u64)
      (return:24)
      (@tdep:4 User)
    )
    (method:25 save
      (parameter:26 self @type:20 UserRepository)
      (parameter:27 user @type:4 User)
      (return:28 @type:4 User)
      (@tdep:4 User)
    )
  )
  (func:29 get_user
    (parameter:30 id @type u64)
    (return:31)
    (@tdep:4 User)
  )
)

(root:32 order_service ($TMP/service/src/order_service.rs)
  (trait:33 OrderRepository
    (method:34 find_by_id
      (parameter:35 self @type:33 OrderRepository)
      (parameter:36 id @type u64)
      (return:37)
      (@tdep:7 Order)
    )
    (method:38 update_status
      (parameter:39 self @type:33 OrderRepository)
      (parameter:40 id @type u64)
      (parameter:41 status @type:11 OrderStatus)
      (@tdep:11 OrderStatus)
    )
  )
  (func:42 process_order
    (parameter:43 order @type:7 Order)
    (return:44 @type:11 OrderStatus)
    (@tdep:7 Order)
    (@tdep:11 OrderStatus)
  )
)

(root:45 lib ($TMP/api/src/lib.rs)
  (module:46 handlers)
)

(root:47 handlers ($TMP/api/src/handlers.rs)
  (class:48 ApiResponse
    (field:49 success @type bool)
    (field:50 data @type:4 User)
    (@tdep:4 User)
  )
  (func:51 handle_get_user
    (parameter:52 id @type u64)
    (return:53 @type:48 ApiResponse)
    (@tdep:48 ApiResponse)
  )
  (func:56 handle_order
    (parameter:57 order @type:7 Order)
    (return:58 @type bool)
    (@tdep:7 Order)
  )
)

--- expect:arch-graph ---
digraph architecture {
  rankdir=TB;
  ranksep=0.6;
  nodesep=0.3;
  splines=ortho;
  compound=true;

  node [shape=box, style=rounded];
  edge [arrowsize=0.7];

  subgraph cluster_api {
    label="api";
    style=rounded;
        bgcolor="#f8f8f8";

    subgraph cluster_handlers_rs {
      label="handlers.rs";
      style=rounded;
            bgcolor="#fafafa";

      n51[label="handle_get_user", path="$TMP/api/src/handlers.rs:10", sym_ty="Function", shape=ellipse];
      n56[label="handle_order", path="$TMP/api/src/handlers.rs:15", sym_ty="Function", shape=ellipse];
      n48[label="ApiResponse", path="$TMP/api/src/handlers.rs:5", sym_ty="Struct", shape=box];
    }

  }

  subgraph cluster_domain {
    label="domain";
    style=rounded;
        bgcolor="#f8f8f8";

    subgraph cluster_models_rs {
      label="models.rs";
      style=rounded;
            bgcolor="#fafafa";

      n4[label="User", path="$TMP/domain/src/models.rs:1", sym_ty="Struct", shape=box];
      n11[label="OrderStatus", path="$TMP/domain/src/models.rs:12", sym_ty="Enum", shape=box];
      n7[label="Order", path="$TMP/domain/src/models.rs:6", sym_ty="Struct", shape=box];
    }

  }

  subgraph cluster_service {
    label="service";
    style=rounded;
        bgcolor="#f8f8f8";

    subgraph cluster_order_service_rs {
      label="order_service.rs";
      style=rounded;
            bgcolor="#fafafa";

      n42[label="process_order", path="$TMP/service/src/order_service.rs:8", sym_ty="Function", shape=ellipse];
    }

    subgraph cluster_user_service_rs {
      label="user_service.rs";
      style=rounded;
            bgcolor="#fafafa";

      n29[label="get_user", path="$TMP/service/src/user_service.rs:8", sym_ty="Function", shape=ellipse];
    }

  }


  n4 -> n48 [from="type_dep", to="struct"];
  n7 -> n42 [from="input", to="func"];
  n7 -> n56 [from="input", to="func"];
  n29 -> n4 [from="func", to="type_dep"];
  n42 -> n11 [from="func", to="output"];
  n51 -> n48 [from="func", to="output"];
}
