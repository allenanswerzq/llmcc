===============================================================================
mixed-state-machine
===============================================================================
State machine pattern with enum states and trait transitions.
Combines: enums for states, traits for behavior, generics, PhantomData pattern.

--- file: sample/Cargo.toml ---
[package]
name = "sample"

--- file: sample/src/lib.rs ---
mod states;
mod machine;
mod transitions;

--- file: sample/src/states.rs ---
pub struct Idle;
pub struct Running;
pub struct Stopped;

pub trait State {
    fn name(&self) -> &'static str;
}

impl State for Idle {
    fn name(&self) -> &'static str { "idle" }
}

impl State for Running {
    fn name(&self) -> &'static str { "running" }
}

impl State for Stopped {
    fn name(&self) -> &'static str { "stopped" }
}

--- file: sample/src/machine.rs ---
use crate::states::{State, Idle};

pub struct Machine<S: State> {
    pub state: S,
    pub data: String,
}

impl Machine<Idle> {
    pub fn new() -> Self {
        Machine {
            state: Idle,
            data: String::new(),
        }
    }
}

--- file: sample/src/transitions.rs ---
use crate::states::{State, Idle, Running, Stopped};
use crate::machine::Machine;

pub trait Transition<To: State> {
    fn transition(self) -> Machine<To>;
}

impl Transition<Running> for Machine<Idle> {
    fn transition(self) -> Machine<Running> {
        Machine {
            state: Running,
            data: self.data,
        }
    }
}

impl Transition<Stopped> for Machine<Running> {
    fn transition(self) -> Machine<Stopped> {
        Machine {
            state: Stopped,
            data: self.data,
        }
    }
}

impl Transition<Idle> for Machine<Stopped> {
    fn transition(self) -> Machine<Idle> {
        Machine {
            state: Idle,
            data: self.data,
        }
    }
}

--- expect:block-graph ---
(root:1 lib ($TMP/sample/src/lib.rs)
  (module:2 states)
  (module:3 machine)
  (module:4 transitions)
)

(root:5 states ($TMP/sample/src/states.rs)
  (class:6 Idle)
  (class:7 Running)
  (class:8 Stopped)
  (trait:9 State
    (method:10 name
      (parameter:11 self @type:9 State)
      (return:12 @type str)
    )
  )
  (impl:13 Idle @type:6 @trait:9
    (method:14 name
      (parameter:15 self @type:6 Idle)
      (return:16 @type str)
    )
  )
  (impl:17 Running @type:7 @trait:9
    (method:18 name
      (parameter:19 self @type:7 Running)
      (return:20 @type str)
    )
  )
  (impl:21 Stopped @type:8 @trait:9
    (method:22 name
      (parameter:23 self @type:8 Stopped)
      (return:24 @type str)
    )
  )
)

(root:25 machine ($TMP/sample/src/machine.rs)
  (class:26 Machine
    (field:27 state @type:9 State)
    (field:28 data @type String)
    (@tdep:6 Idle)
    (@tdep:7 Running)
    (@tdep:8 Stopped)
    (@tdep:9 State)
  )
  (impl:29 Machine @type:26
    (method:30 new
      (return:31 @type:26 Machine)
    )
  )
)

(root:33 transitions ($TMP/sample/src/transitions.rs)
  (trait:34 Transition
    (method:35 transition
      (parameter:36 self @type:34 Transition)
      (return:37 @type:26 Machine)
      (@tdep:9 State)
      (@tdep:26 Machine)
    )
  )
  (impl:38 Machine @type:26 @trait:34
    (method:39 transition
      (parameter:40 self @type:26 Machine)
      (return:41 @type:26 Machine)
      (@tdep:6 Idle)
      (@tdep:7 Running)
      (@tdep:8 Stopped)
    )
  )
  (impl:42 Machine @type:26 @trait:34
    (method:43 transition
      (parameter:44 self @type:26 Machine)
      (return:45 @type:26 Machine)
      (@tdep:6 Idle)
      (@tdep:7 Running)
      (@tdep:8 Stopped)
    )
  )
  (impl:46 Machine @type:26 @trait:34
    (method:47 transition
      (parameter:48 self @type:26 Machine)
      (return:49 @type:26 Machine)
      (@tdep:6 Idle)
      (@tdep:7 Running)
      (@tdep:8 Stopped)
    )
  )
)

--- expect:arch-graph ---
digraph architecture {
  // Layout settings
  rankdir=TB;
  ranksep=0.6;
  nodesep=0.3;
  splines=ortho;
  compound=true;

  node [shape=box, style=rounded];
  edge [arrowsize=0.7];

  subgraph cluster_sample {
    label="sample";
    style=rounded;
    color="#888888";
    bgcolor="#f0f0f0";

    subgraph cluster_machine_rs {
      label="machine.rs";
      style=rounded;
      color="#aaaaaa";
      bgcolor="#fafafa";

      n26[label="Machine", full_path="$TMP/sample/src/machine.rs:3", sym_ty="Struct", shape=box];
    }

    subgraph cluster_states_rs {
      label="states.rs";
      style=rounded;
      color="#aaaaaa";
      bgcolor="#fafafa";

      n6[label="Idle", full_path="$TMP/sample/src/states.rs:1", sym_ty="Struct", shape=box];
      n7[label="Running", full_path="$TMP/sample/src/states.rs:2", sym_ty="Struct", shape=box];
      n8[label="Stopped", full_path="$TMP/sample/src/states.rs:3", sym_ty="Struct", shape=box];
      n9[label="State", full_path="$TMP/sample/src/states.rs:5", sym_ty="Trait", shape=box];
    }

    subgraph cluster_transitions_rs {
      label="transitions.rs";
      style=rounded;
      color="#aaaaaa";
      bgcolor="#fafafa";

      n34[label="Transition", full_path="$TMP/sample/src/transitions.rs:4", sym_ty="Trait", shape=box];
    }

  }


  n6 -> n26 [from="type_arg", to="impl"];
  n7 -> n26 [from="type_arg", to="impl"];
  n8 -> n26 [from="type_arg", to="impl"];
  n9 -> n6 [from="trait", to="impl"];
  n9 -> n7 [from="trait", to="impl"];
  n9 -> n8 [from="trait", to="impl"];
  n9 -> n26 [from="field_type", to="struct"];
  n9 -> n34 [from="bound", to="generic"];
  n34 -> n26 [from="trait", to="impl"];
}
