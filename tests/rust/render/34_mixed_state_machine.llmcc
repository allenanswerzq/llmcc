===============================================================================
mixed-state-machine
===============================================================================
State machine pattern with enum states and trait transitions.
Combines: enums for states, traits for behavior, generics, PhantomData pattern.

--- file: sample/Cargo.toml ---
[package]
name = "sample"

--- file: sample/src/lib.rs ---
mod states;
mod machine;
mod transitions;

--- file: sample/src/states.rs ---
pub struct Idle;
pub struct Running;
pub struct Stopped;

pub trait State {
    fn name(&self) -> &'static str;
}

impl State for Idle {
    fn name(&self) -> &'static str { "idle" }
}

impl State for Running {
    fn name(&self) -> &'static str { "running" }
}

impl State for Stopped {
    fn name(&self) -> &'static str { "stopped" }
}

--- file: sample/src/machine.rs ---
use crate::states::{State, Idle};

pub struct Machine<S: State> {
    pub state: S,
    pub data: String,
}

impl Machine<Idle> {
    pub fn new() -> Self {
        Machine {
            state: Idle,
            data: String::new(),
        }
    }
}

--- file: sample/src/transitions.rs ---
use crate::states::{State, Idle, Running, Stopped};
use crate::machine::Machine;

pub trait Transition<To: State> {
    fn transition(self) -> Machine<To>;
}

impl Transition<Running> for Machine<Idle> {
    fn transition(self) -> Machine<Running> {
        Machine {
            state: Running,
            data: self.data,
        }
    }
}

impl Transition<Stopped> for Machine<Running> {
    fn transition(self) -> Machine<Stopped> {
        Machine {
            state: Stopped,
            data: self.data,
        }
    }
}

impl Transition<Idle> for Machine<Stopped> {
    fn transition(self) -> Machine<Idle> {
        Machine {
            state: Idle,
            data: self.data,
        }
    }
}

--- expect:block-graph ---
(root:1 lib ($TMP/sample/src/lib.rs))

(root:2 states ($TMP/sample/src/states.rs)
  (class:3 Idle)
  (class:4 Running)
  (class:5 Stopped)
  (trait:6 State
    (method:7 name
      (parameter:8 self @type:6 State)
      (return:9 @type str)
    )
  )
  (impl:10 Idle @type:3 @trait:6
    (method:11 name
      (parameter:12 self @type:3 Idle)
      (return:13 @type str)
    )
  )
  (impl:14 Running @type:4 @trait:6
    (method:15 name
      (parameter:16 self @type:4 Running)
      (return:17 @type str)
    )
  )
  (impl:18 Stopped @type:5 @trait:6
    (method:19 name
      (parameter:20 self @type:5 Stopped)
      (return:21 @type str)
    )
  )
)

(root:22 machine ($TMP/sample/src/machine.rs)
  (class:23 Machine
    (field:24 state @type:6 State)
    (field:25 data @type String)
  )
  (impl:26 Machine @type:23
    (method:27 new
      (return:28 @type:23 Machine)
    )
  )
)

(root:30 transitions ($TMP/sample/src/transitions.rs)
  (trait:31 Transition
    (method:32 transition
      (parameter:33 self @type:31 Transition)
      (return:34 @type:23 Machine)
      (@tdep:6 State)
    )
  )
  (impl:35 Machine @type:23 @trait:31
    (method:36 transition
      (parameter:37 self @type:23 Machine)
      (return:38 @type:23 Machine)
      (@tdep:3 Idle)
      (@tdep:4 Running)
      (@tdep:5 Stopped)
    )
  )
  (impl:39 Machine @type:23 @trait:31
    (method:40 transition
      (parameter:41 self @type:23 Machine)
      (return:42 @type:23 Machine)
      (@tdep:3 Idle)
      (@tdep:4 Running)
      (@tdep:5 Stopped)
    )
  )
  (impl:43 Machine @type:23 @trait:31
    (method:44 transition
      (parameter:45 self @type:23 Machine)
      (return:46 @type:23 Machine)
      (@tdep:3 Idle)
      (@tdep:4 Running)
      (@tdep:5 Stopped)
    )
  )
)

--- expect:arch-graph ---
digraph architecture {
  // Layout settings
  rankdir=TB;
  ranksep=0.6;
  nodesep=0.3;
  splines=ortho;
  compound=true;

  node [shape=box, style=rounded];
  edge [arrowsize=0.7];

  label="architecture graph";
  labelloc=t;

  subgraph cluster_sample {
    label="sample";
    style=rounded;
    color="#888888";
    bgcolor="#f0f0f0";

    subgraph cluster_machine_rs {
      label="machine.rs";
      style=rounded;
      color="#aaaaaa";
      bgcolor="#fafafa";

      n23[label="Machine", full_path="$TMP/sample/src/machine.rs:3", sym_ty="Struct", shape=box];
    }

    subgraph cluster_states_rs {
      label="states.rs";
      style=rounded;
      color="#aaaaaa";
      bgcolor="#fafafa";

      n3[label="Idle", full_path="$TMP/sample/src/states.rs:1", sym_ty="Struct", shape=box];
      n4[label="Running", full_path="$TMP/sample/src/states.rs:2", sym_ty="Struct", shape=box];
      n5[label="Stopped", full_path="$TMP/sample/src/states.rs:3", sym_ty="Struct", shape=box];
      n6[label="State", full_path="$TMP/sample/src/states.rs:5", sym_ty="Trait", shape=box];
    }

    subgraph cluster_transitions_rs {
      label="transitions.rs";
      style=rounded;
      color="#aaaaaa";
      bgcolor="#fafafa";

      n31[label="Transition", full_path="$TMP/sample/src/transitions.rs:4", sym_ty="Trait", shape=box];
    }

  }


  n3 -> n23 [from="type_arg", to="impl"];
  n4 -> n23 [from="type_arg", to="impl"];
  n5 -> n23 [from="type_arg", to="impl"];
  n6 -> n3 [from="trait", to="impl"];
  n6 -> n4 [from="trait", to="impl"];
  n6 -> n5 [from="trait", to="impl"];
  n6 -> n23 [from="field_type", to="struct"];
  n6 -> n31 [from="bound", to="generic"];
  n31 -> n23 [from="trait", to="impl"];
}
